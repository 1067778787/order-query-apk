<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=2.0, user-scalable=yes, viewport-fit=cover">
    <title>è®¢å•å‘è´§æŸ¥è¯¢</title>
    <style>
        /* ----- ç§»åŠ¨ä¼˜å…ˆ å†…æ ¸ (é«˜åº¦ç¼©å‡çº¦1/3) ä¿ç•™åŸæ ·å¼ ----- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: #f1f5f9;
            color: #0f172a;
            padding: 6px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.3;
            -webkit-tap-highlight-color: transparent;
        }

        .app-container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 18px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.02);
            padding: 12px 10px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        h2 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            color: #0f172a;
            letter-spacing: -0.01em;
            padding-left: 2px;
        }
        h2:before {
            content: "ğŸ“¦";
            font-size: 1.4rem;
        }

        .card {
            background: #ffffff;
            border-radius: 16px;
            padding: 12px 12px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
            box-shadow: 0 1px 3px rgba(0,0,0,0.01);
        }

        .token-section {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .token-input-group {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 40px;
            padding: 2px 14px 2px 18px;
            transition: 0.2s;
            width: 100%;
        }
        .token-input-group:focus-within {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37,99,235,0.1);
        }

        .token-input {
            flex: 1;
            border: none;
            padding: 8px 0;
            font-size: 0.9rem;
            background: transparent;
            outline: none;
            min-width: 0;
        }
        input[type="password"].token-input {
            letter-spacing: 0.1em;
        }

        .token-hint {
            font-size: 0.7rem;
            color: #475569;
            padding-left: 4px;
            margin: 0 0 2px 0;
        }

        .token-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-start;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 0;
        }

        .btn {
            border: none;
            background: white;
            padding: 8px 12px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            border: 1px solid #cbd5e1;
            color: #1e293b;
            cursor: pointer;
            transition: 0.15s;
            white-space: nowrap;
            line-height: 1;
            -webkit-appearance: none;
        }
        .btn:active {
            background: #f1f5f9;
            transform: scale(0.97);
        }
        .btn-primary {
            background: #2563eb;
            border-color: #2563eb;
            color: white;
            box-shadow: 0 3px 8px rgba(37,99,235,0.2);
        }
        .btn-primary:active {
            background: #1d4ed8;
        }
        .btn:disabled {
            opacity: 0.45;
            pointer-events: none;
            background: #e2e8f0;
            border-color: #cbd5e1;
            color: #64748b;
        }

        .fetch-row {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        /* éšè—æ•°é‡é€‰æ‹©å™¨ (é»˜è®¤3000ä¸æ˜¾ç¤º) */
        .count-wrapper {
            display: none;
        }

        .action-buttons {
            display: flex;
            flex-wrap: nowrap;
            align-items: center;
            gap: 6px;
            margin-top: 2px;
            width: 100%;
        }
        .action-buttons .btn {
            flex: 1 1 0;
            min-width: 0;
            padding: 8px 4px;
            font-size: 0.75rem;
        }
        .action-buttons .btn-primary {
            flex: 1.2 1 0;
        }

        .tabs {
            display: flex;
            background: #f1f5f9;
            padding: 3px;
            border-radius: 40px;
            margin: 4px 0 10px 0;
        }
        .tab {
            flex: 1;
            text-align: center;
            padding: 8px 2px;
            border-radius: 40px;
            background: transparent;
            border: none;
            font-weight: 600;
            color: #475569;
            transition: 0.1s;
            cursor: pointer;
            font-size: 0.75rem;
            white-space: nowrap;
        }
        .tab.active {
            background: white;
            color: #0f172a;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            font-weight: 700;
        }

        .panel {
            background: white;
            border-radius: 16px;
            border: 1px solid #e2e8f0;
            margin-top: 2px;
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 320px;
            max-height: 62vh;
        }

        .table-wrapper {
            overflow-x: auto;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.65rem;
            min-width: 1000px;
        }
        th {
            background: #f8fafc;
            color: #1e293b;
            font-weight: 700;
            padding: 8px 4px;
            border-bottom: 2px solid #e2e8f0;
            text-align: left;
            white-space: nowrap;
            font-size: 0.65rem;
        }
        td {
            padding: 6px 4px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: middle;
            white-space: nowrap;
        }
        tr {
            transition: background 0.1s;
        }
        tr:active {
            background: #e6f2ff;
        }
        tr.selected {
            background-color: #e6f2ff !important;
            border-left: 3px solid #2563eb;
        }

        .detail-content, .log-content {
            padding: 12px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 0.7rem;
            background: #0f172a;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-break: break-word;
            height: 100%;
            overflow-y: auto;
            line-height: 1.4;
        }
        .log-content {
            background: #1e293b;
            color: #cbd5e1;
        }

        .status-bar {
            margin-top: 10px;
            padding: 8px 12px;
            background: #f8fafc;
            border-radius: 40px;
            font-size: 0.75rem;
            color: #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #e2e8f0;
        }
        .badge {
            background: #e2e8f0;
            padding: 3px 10px;
            border-radius: 40px;
            font-weight: 600;
        }

        .footer-note {
            margin-top: 8px;
            color: #64748b;
            font-size: 0.6rem;
            text-align: center;
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 8px 6px;
            }
            h2 {
                font-size: 1.2rem;
                margin-bottom: 8px;
            }
            .btn {
                padding: 6px 8px;
                font-size: 0.7rem;
            }
            .token-input {
                padding: 6px 0;
                font-size: 0.85rem;
            }
            .action-buttons .btn {
                padding: 6px 2px;
                font-size: 0.65rem;
            }
            .tabs .tab {
                font-size: 0.65rem;
                padding: 6px 2px;
            }
            .panel {
                min-height: 280px;
            }
            th, td {
                padding: 5px 3px;
                font-size: 0.6rem;
            }
            .status-bar {
                padding: 6px 10px;
                font-size: 0.7rem;
            }
            .badge {
                padding: 2px 8px;
            }
        }

        @media (min-width: 1024px) {
            body {
                padding: 12px 20px;
            }
            .app-container {
                max-width: 1600px;
                padding: 18px 22px;
            }
            h2 {
                font-size: 1.8rem;
                margin-bottom: 16px;
            }
            .btn {
                padding: 10px 20px;
                font-size: 0.95rem;
            }
            .token-input {
                padding: 10px 0;
                font-size: 1rem;
            }
            .action-buttons .btn {
                padding: 10px 14px;
                font-size: 0.95rem;
            }
            .table-wrapper {
                max-height: 68vh;
            }
            table {
                font-size: 0.85rem;
            }
            th, td {
                padding: 12px 10px;
            }
        }

        button, .btn, .tab, tr {
            touch-action: manipulation;
        }
    </style>
</head>
<body>
<div class="app-container" id="app">
    <h2>è®¢å•å‘è´§æŸ¥è¯¢</h2>
    
    <!-- æˆæƒå¡ç‰‡ (ä»¤ç‰Œæ©ç ) -->
    <div class="card token-section">
        <div class="token-input-group">
            <input type="password" id="tokenInput" class="token-input" placeholder="Bearerä»¤ç‰Œ" autocomplete="off" value="">
        </div>
        <div class="token-hint">
            âš¡ ä»¤ç‰Œå·²åŠ å¯† Authorization:
        </div>
        <div class="token-buttons">
            <button id="saveTokenBtn" class="btn">ä¿å­˜</button>
            <button id="clearTokenBtn" class="btn">æ¸…ç©º</button>
        </div>
    </div>

    <!-- è·å–è®¾ç½®å¡ç‰‡ (æ•°é‡é€‰æ‹©å·²éšè—ï¼Œé»˜è®¤3000) -->
    <div class="card">
        <div class="fetch-row">
            <!-- æ•°é‡é€‰æ‹©å™¨éšè—ï¼Œä½†åŠŸèƒ½ä¿ç•™ (é»˜è®¤3000) -->
            <div class="count-wrapper" style="display: none;">
                <span>è·å–æ•°é‡</span>
                <input type="number" id="countInput" class="number-input" min="1" max="5000" value="3000" step="1">
            </div>
            <div class="action-buttons">
                <button id="fetchBtn" class="btn btn-primary">è·å–</button>
                <button id="detailBtn" class="btn" disabled>è¯¦æƒ…</button>
                <button id="copyTrackingBtn" class="btn" disabled>å¤å¿«</button>
                <button id="clearLogBtn" class="btn">æ¸…ç©º</button>
            </div>
        </div>
    </div>

    <!-- æ ‡ç­¾é¡µåˆ‡æ¢ -->
    <div class="tabs" id="tabHeaders">
        <button class="tab active" data-tab="orderList">ğŸ“‹ è®¢å•åˆ—è¡¨</button>
        <button class="tab" data-tab="detailView">ğŸ” è®¢å•è¯¦æƒ…</button>
        <button class="tab" data-tab="logView">ğŸ“œ æ—¥å¿—</button>
    </div>

    <!-- åŠ¨æ€é¢æ¿ -->
    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
        <!-- è®¢å•åˆ—è¡¨ -->
        <div id="orderListPanel" class="panel" style="display: flex;">
            <div class="table-wrapper" id="tableWrapper">
                <table id="orderTable">
                    <thead id="tableHeader">
                        <tr>
                            <th>è®¢å•ID</th><th>çŠ¶æ€</th><th>ä»£ä¸‹å•æ—¶é—´</th><th>å‘è´§æ—¶é—´</th><th>å¿«é€’å•å·</th>
                            <th>å¿«é€’å…¬å¸</th><th>å‘è´§åˆ†éƒ¨</th><th>æ”¶è´§äºº</th><th>çœä»½</th><th>è®¢å•é‡‘é¢</th>
                            <th>å•†å“é‡‘é¢</th><th>è¿è´¹</th><th>åˆ›å»ºæ—¶é—´</th><th>ç­¾æ”¶æ—¶é—´</th><th>å®Œæˆæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <tr><td colspan="15" style="text-align: center; padding: 20px;">ğŸ“­ æš‚æ— æ•°æ®ï¼Œè¯·è·å–è®¢å•</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        <!-- è¯¦æƒ…é¢æ¿ -->
        <div id="detailViewPanel" class="panel" style="display: none;">
            <pre id="detailPre" class="detail-content">âš¡ é€‰ä¸­ä¸€è¡Œï¼Œç‚¹å‡»ã€è®¢å•è¯¦æƒ…ã€‘</pre>
        </div>
        <!-- æ—¥å¿—é¢æ¿ -->
        <div id="logViewPanel" class="panel" style="display: none;">
            <div id="logContent" class="log-content">[ç³»ç»Ÿ] å°±ç»ª Â· é»˜è®¤è·å–3000æ¡ Â· æ•°é‡é€‰æ‹©å·²éšè—</div>
        </div>
    </div>

    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <span id="statusMsg">å°±ç»ªï¼Œç‚¹å‡»è¡Œé€‰ä¸­</span>
        <span id="rowCountBadge" class="badge">0 ä¸ªè®¢å•</span>
    </div>
    <div class="footer-note">
        âš¡ æ¨ªå‘æ»‘åŠ¨è¡¨æ ¼ | è®¢å•IDå‰3*å3 | æ—¶é—´æ— ç§’ | çœä»½ç®€ç§° | é»˜è®¤3000
    </div>
</div>

<script>
    (function(){
        "use strict";

        // ---------- å…¨å±€çŠ¶æ€ ----------
        const STATE = {
            orderItems: [],
            selectedRowIndex: -1,
            currentDetailOrder: null,
        };

        // DOM å…ƒç´ 
        const tokenInput = document.getElementById('tokenInput');
        const saveTokenBtn = document.getElementById('saveTokenBtn');
        const clearTokenBtn = document.getElementById('clearTokenBtn');
        const countInput = document.getElementById('countInput');
        const fetchBtn = document.getElementById('fetchBtn');
        const detailBtn = document.getElementById('detailBtn');
        const copyTrackingBtn = document.getElementById('copyTrackingBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const orderTableBody = document.getElementById('orderTableBody');
        const statusMsg = document.getElementById('statusMsg');
        const rowCountBadge = document.getElementById('rowCountBadge');
        const logContent = document.getElementById('logContent');
        const detailPre = document.getElementById('detailPre');

        const tabs = document.querySelectorAll('.tab');
        const panels = {
            orderList: document.getElementById('orderListPanel'),
            detailView: document.getElementById('detailViewPanel'),
            logView: document.getElementById('logViewPanel')
        };

        // ---------- å·¥å…·å‡½æ•° ----------
        function log(message) {
            const timestamp = new Date().toLocaleString('zh-CN', { hour12: false });
            const logLine = `[${timestamp}] ${message}`;
            let current = logContent.innerText || logContent.textContent;
            let lines = current.split('\n');
            if (lines.length > 150) lines = lines.slice(-130);
            lines.push(logLine);
            logContent.innerText = lines.join('\n');
            if (panels.logView.style.display !== 'none') {
                logContent.scrollTop = logContent.scrollHeight;
            }
        }

        function setStatus(text) {
            statusMsg.innerText = text;
        }

        function centsToYuan(cents) {
            if (cents === null || cents === undefined) return '0.00';
            return (parseFloat(cents) / 100).toFixed(2);
        }

        /** æ ¼å¼åŒ–æ—¶é—´: å»æ‰ç§’ */
        function formatTime(timeStr) {
            if (!timeStr) return '';
            try {
                let clean = timeStr.split('+')[0].replace('T', ' ');
                if (clean.includes('.')) clean = clean.split('.')[0];
                const dt = new Date(clean);
                if (isNaN(dt.getTime())) return timeStr;
                const year = dt.getFullYear();
                const month = String(dt.getMonth() + 1).padStart(2, '0');
                const day = String(dt.getDate()).padStart(2, '0');
                const hour = String(dt.getHours()).padStart(2, '0');
                const minute = String(dt.getMinutes()).padStart(2, '0');
                return `${year}-${month}-${day} ${hour}:${minute}`;
            } catch {
                return timeStr;
            }
        }

        /** æ ¼å¼åŒ–è®¢å•ID: å‰3 + * + å3 */
        function formatOrderId(id) {
            if (!id) return '';
            const str = String(id);
            if (str.length <= 6) return str;
            const firstThree = str.slice(0, 3);
            const lastThree = str.slice(-3);
            return `${firstThree}*${lastThree}`;
        }

        /** çœä»½ç®€ç§°æ˜ å°„ */
        function simplifyProvince(fullName) {
            const map = {
                "åŒ—äº¬å¸‚":"åŒ—äº¬", "å¤©æ´¥å¸‚":"å¤©æ´¥", "ä¸Šæµ·å¸‚":"ä¸Šæµ·", "é‡åº†å¸‚":"é‡åº†",
                "æ²³åŒ—çœ":"æ²³åŒ—", "å±±è¥¿çœ":"å±±è¥¿", "è¾½å®çœ":"è¾½å®", "å‰æ—çœ":"å‰æ—", "é»‘é¾™æ±Ÿçœ":"é»‘é¾™æ±Ÿ",
                "æ±Ÿè‹çœ":"æ±Ÿè‹", "æµ™æ±Ÿçœ":"æµ™æ±Ÿ", "å®‰å¾½çœ":"å®‰å¾½", "ç¦å»ºçœ":"ç¦å»º", "æ±Ÿè¥¿çœ":"æ±Ÿè¥¿",
                "å±±ä¸œçœ":"å±±ä¸œ", "æ²³å—çœ":"æ²³å—", "æ¹–åŒ—çœ":"æ¹–åŒ—", "æ¹–å—çœ":"æ¹–å—", "å¹¿ä¸œçœ":"å¹¿ä¸œ",
                "æµ·å—çœ":"æµ·å—", "å››å·çœ":"å››å·", "è´µå·çœ":"è´µå·", "äº‘å—çœ":"äº‘å—", "é™•è¥¿çœ":"é™•è¥¿",
                "ç”˜è‚ƒçœ":"ç”˜è‚ƒ", "é’æµ·çœ":"é’æµ·", "å°æ¹¾çœ":"å°æ¹¾",
                "å†…è’™å¤è‡ªæ²»åŒº":"å†…è’™å¤", "å¹¿è¥¿å£®æ—è‡ªæ²»åŒº":"å¹¿è¥¿", "è¥¿è—è‡ªæ²»åŒº":"è¥¿è—", "å®å¤å›æ—è‡ªæ²»åŒº":"å®å¤",
                "æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº":"æ–°ç–†", "é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº":"é¦™æ¸¯", "æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº":"æ¾³é—¨"
            };
            return map[fullName] || fullName;
        }

        /** æå–çœä»½å¹¶åº”ç”¨ç®€ç§° */
        function extractProvince(address) {
            if (!address) return '';
            let raw = address;
            if (address.includes(',')) raw = address.split(',')[0].trim();
            else if (address.includes('ï¼Œ')) raw = address.split('ï¼Œ')[0].trim();
            else raw = address.trim();
            return simplifyProvince(raw);
        }

        function getFactoryFromTags(tags) {
            if (!Array.isArray(tags)) return '';
            for (let tag of tags) {
                if (tag.name && tag.name.includes('åˆ†éƒ¨')) return tag.name;
            }
            return '';
        }

        function getStateText(state) {
            const map = {1:'å¾…å‘è´§',2:'å·²å‘è´§',3:'å·²å®Œæˆ',4:'å·²å–æ¶ˆ',5:'å¾…ä»˜æ¬¾',6:'å·²ç­¾æ”¶'};
            return map[state] || `æœªçŸ¥(${state})`;
        }

        function getStateColor(state) {
            const map = {1:'#fff3cd',2:'#d4edda',3:'#d0e2ff',4:'#f8d7da',5:'#fff3cd',6:'#c3e6cb'};
            return map[state] || '#f8f9fa';
        }

        // ---------- ä»¤ç‰Œå­˜å‚¨ ----------
        function saveToken() {
            const token = tokenInput.value.trim();
            try {
                const cfg = JSON.parse(localStorage.getItem('orderQueryConfig') || '{}');
                cfg.token = token;
                localStorage.setItem('orderQueryConfig', JSON.stringify(cfg));
                log('ä»¤ç‰Œå·²ä¿å­˜åˆ°æœ¬åœ°');
                setStatus('ä»¤ç‰Œä¿å­˜æˆåŠŸ');
            } catch(e) {
                log('ä¿å­˜ä»¤ç‰Œå¤±è´¥');
            }
        }

        function clearToken() {
            tokenInput.value = '';
            saveToken(); 
            log('å·²æ¸…ç©ºä»¤ç‰Œå¹¶ä¿å­˜');
        }

        function saveConfig() {
            try {
                const cfg = {
                    token: tokenInput.value,
                    count: countInput.value,
                };
                localStorage.setItem('orderQueryConfig', JSON.stringify(cfg));
            } catch(e) {}
        }

        function loadConfig() {
            try {
                const cfg = localStorage.getItem('orderQueryConfig');
                if (cfg) {
                    const p = JSON.parse(cfg);
                    tokenInput.value = p.token || '';
                    // å¦‚æœé…ç½®ä¸­æœ‰countï¼Œä½¿ç”¨é…ç½®å€¼ï¼Œå¦åˆ™é»˜è®¤3000
                    countInput.value = p.count || 3000;
                } else {
                    // æ— é…ç½®æ—¶é»˜è®¤3000
                    countInput.value = 3000;
                }
            } catch(e) {
                countInput.value = 3000; // å¼‚å¸¸æ—¶ä¹Ÿè®¾ä¸º3000
            }
        }

        // ---------- æ¸²æŸ“è®¢å•è¡¨æ ¼ ----------
        function renderOrderTable(orders) {
            if (!orders || orders.length === 0) {
                orderTableBody.innerHTML = `<tr><td colspan="15" style="text-align: center; padding: 20px;">ğŸ“­ æš‚æ— è®¢å•æ•°æ®ï¼Œè¯·ç‚¹å‡»ã€è·å–è®¢å•ã€‘</td></tr>`;
                rowCountBadge.innerText = '0 ä¸ªè®¢å•';
                return;
            }
            let html = '';
            orders.forEach((order, rowIndex) => {
                const state = order.state || 0;
                const stateText = getStateText(state);
                const bgColor = getStateColor(state);
                let trackingSn = 'æ— ', supplierName = 'æœªå‘è´§';
                if (order.ships && order.ships.length) {
                    trackingSn = order.ships[0].sn || 'æ— ';
                    supplierName = order.ships[0].supplier?.name || 'æœªå‘è´§';
                }
                let factoryText = getFactoryFromTags(order.tag);
                if (!factoryText) {
                    const factoryMap = {1:'é•¿æ²™åˆ†éƒ¨',2:'ä¹‰ä¹Œåˆ†éƒ¨',3:'æµå—åˆ†éƒ¨',4:'æˆéƒ½åˆ†éƒ¨',5:'ä¸œèåˆ†éƒ¨',6:'è¥¿å®‰åˆ†éƒ¨'};
                    factoryText = factoryMap[order.factory] || `æœªçŸ¥(${order.factory})`;
                }
                let addressee = order.addressee || '';
                addressee = addressee.split('ï¼ˆ')[0].split('(')[0];
                const province = extractProvince(order.address);  // å·²åº”ç”¨ç®€ç§°
                const amountYuan = `Â¥${centsToYuan(order.amount)}`;
                const itemsAmountYuan = `Â¥${centsToYuan(order.items_amount)}`;
                const shipAmountYuan = `Â¥${centsToYuan(order.ship_amount)}`;
                const paidAt = formatTime(order.paid_at);
                const shipAt = formatTime(order.ship_at);
                const createdAt = formatTime(order.created_at);
                const signAt = formatTime(order.sign_at);
                const finishedAt = formatTime(order.finished_at);

                html += `<tr data-row-index="${rowIndex}" style="cursor: pointer;">`;
                html += `<td>${formatOrderId(order.id) || ''}</td>`;
                html += `<td style="background-color: ${bgColor};">${stateText}</td>`;
                html += `<td>${paidAt}</td><td>${shipAt}</td>`;
                html += `<td>${trackingSn}</td><td>${supplierName}</td>`;
                html += `<td>${factoryText}</td><td>${addressee}</td><td>${province}</td>`;
                html += `<td>${amountYuan}</td><td>${itemsAmountYuan}</td><td>${shipAmountYuan}</td>`;
                html += `<td>${createdAt}</td><td>${signAt}</td><td>${finishedAt}</td>`;
                html += `</tr>`;
            });
            orderTableBody.innerHTML = html;
            rowCountBadge.innerText = `${orders.length} ä¸ªè®¢å•`;

            document.querySelectorAll('#orderTable tbody tr').forEach(tr => {
                tr.addEventListener('click', function(e) {
                    document.querySelectorAll('#orderTable tbody tr').forEach(r => r.classList.remove('selected'));
                    this.classList.add('selected');
                    const idx = parseInt(this.dataset.rowIndex, 10);
                    STATE.selectedRowIndex = idx;
                    STATE.currentDetailOrder = STATE.orderItems[idx];
                    detailBtn.disabled = false;
                    copyTrackingBtn.disabled = false;
                    setStatus(`å·²é€‰ä¸­: ${formatOrderId(STATE.orderItems[idx].id)}`);
                });
                tr.addEventListener('dblclick', function() {
                    const idx = parseInt(this.dataset.rowIndex, 10);
                    showOrderDetail(STATE.orderItems[idx]);
                    switchTab('detailView');
                });
            });
        }

        function showOrderDetail(order) {
            if (!order) {
                detailPre.innerText = 'âš ï¸ æ²¡æœ‰é€‰ä¸­ä»»ä½•è®¢å•';
                return;
            }
            let detail = `=== è®¢å•è¯¦æƒ… ===\n`;
            detail += `è®¢å•ID: ${formatOrderId(order.id) || ''}\n`;
            detail += `çŠ¶æ€: ${order.state} (${getStateText(order.state)})\n`;
            detail += `æ‰“å°çŠ¶æ€: ${order.print_state ?? ''}\n\n`;
            detail += `=== æ—¶é—´ (æ— ç§’) ===\nåˆ›å»º: ${formatTime(order.created_at)}\næ”¯ä»˜: ${formatTime(order.paid_at)}\nå‘è´§: ${formatTime(order.ship_at)}\nç­¾æ”¶: ${formatTime(order.sign_at)}\nå®Œæˆ: ${formatTime(order.finished_at)}\n\n`;
            detail += `=== é‡‘é¢(å…ƒ) ===\næ€»é¢: Â¥${centsToYuan(order.amount)}\nå•†å“: Â¥${centsToYuan(order.items_amount)}\nè¿è´¹: Â¥${centsToYuan(order.ship_amount)}\nå®ä»˜: Â¥${centsToYuan(order.real_amount)}\n\n`;
            detail += `=== æ”¶è´§ ===\n${order.addressee || ''} ${order.phone || ''}\n${order.address || ''}\nçœä»½: ${extractProvince(order.address)}\n\n`;  // çœä»½ç®€ç§°
            detail += `=== å¿«é€’ ===\n`;
            if (order.ships?.length) {
                order.ships.forEach((s,i)=> {
                    detail += `åŒ…è£¹${i+1}: ${s.sn || ''} ${s.supplier?.name || ''}\nçŠ¶æ€: ${s.state || ''}\n`;
                });
            } else detail += `æ— \n`;
            detail += `\n=== æ ‡ç­¾ ===\n`;
            if (order.tag?.length) order.tag.forEach(t=> detail += `${t.name} `);
            else detail += 'æ— ';
            detail += `\n\n=== è®¢å•é¡¹ ===\n`;
            if (order.order_items) {
                order.order_items.slice(0,3).forEach((item, idx) => {
                    const cust = item.custom_attributes || {};
                    detail += `${idx+1}. ${cust['æ–‡ä»¶å'] || '--'} é¡µæ•°:${cust['æ–‡ä»¶é¡µæ•°']||''}\né‡‘é¢:Â¥${centsToYuan(item.amount)}\n`;
                });
                if (order.order_items.length > 3) detail += `...ç­‰${order.order_items.length}é¡¹\n`;
            }
            detailPre.innerText = detail;
        }

        // å¤åˆ¶å¿«é€’å•å· (ä¿æŒä¸å˜)
        async function copyTrackingNumber() {
            if (STATE.selectedRowIndex === -1 || !STATE.orderItems[STATE.selectedRowIndex]) {
                alert('è¯·å…ˆé€‰ä¸­ä¸€è¡Œè®¢å•');
                return;
            }
            const order = STATE.orderItems[STATE.selectedRowIndex];
            if (!order.ships?.length || !order.ships[0].sn) {
                alert('è¯¥è®¢å•æ²¡æœ‰å¿«é€’å•å·');
                return;
            }
            const tracking = order.ships[0].sn;
            let addressee = order.addressee || 'æœªçŸ¥æ”¶ä»¶äºº';
            addressee = addressee.split('ï¼ˆ')[0].split('(')[0];
            const copyText = tracking;

            if (navigator.clipboard && navigator.clipboard.writeText) {
                try {
                    await navigator.clipboard.writeText(copyText);
                    const msg = `å¿«é€’å•å·å·²å¤åˆ¶: ${tracking}ï¼Œæ”¶ä»¶äºº: ${addressee}`;
                    log(msg);
                    setStatus(`å·²å¤åˆ¶: ${tracking}`);
                    alert(msg);
                    return;
                } catch (err) {
                    log(`clipboard API å¤±è´¥: ${err}, å°è¯•å›é€€æ–¹æ³•`);
                }
            }

            try {
                const textarea = document.createElement('textarea');
                textarea.value = copyText;
                textarea.style.position = 'fixed';
                textarea.style.opacity = '0';
                document.body.appendChild(textarea);
                textarea.select();
                textarea.setSelectionRange(0, 99999);
                const successful = document.execCommand('copy');
                document.body.removeChild(textarea);
                if (successful) {
                    const msg = `å¿«é€’å•å·å·²å¤åˆ¶: ${tracking}ï¼Œæ”¶ä»¶äºº: ${addressee}`;
                    log(msg);
                    setStatus(`å·²å¤åˆ¶: ${tracking}`);
                    alert(msg);
                } else {
                    throw new Error('execCommand è¿”å› false');
                }
            } catch (e) {
                log(`ä¼ ç»Ÿå¤åˆ¶å¤±è´¥: ${e}`);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶å•å·: ' + tracking);
            }
        }

        function switchTab(tabId) {
            tabs.forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tabId);
            });
            Object.keys(panels).forEach(key => panels[key].style.display = 'none');
            panels[tabId].style.display = 'flex';
            if (tabId === 'detailView' && STATE.currentDetailOrder) {
                showOrderDetail(STATE.currentDetailOrder);
            }
        }

        // ---------- è·å–è®¢å•API ----------
        async function fetchOrders() {
            const token = tokenInput.value.trim();
            if (!token) {
                alert('è¯·è¾“å…¥æˆæƒä»¤ç‰Œï¼');
                return;
            }
            const authHeader = token.startsWith('Bearer ') ? token : `Bearer ${token}`;
            // ä»éšè—çš„è¾“å…¥æ¡†è¯»å–æ•°é‡ï¼Œé»˜è®¤3000
            const pageSizeTarget = parseInt(countInput.value, 10) || 3000;
            const perRequest = 100;

            setStatus('æ­£åœ¨è·å–è®¢å•...');
            fetchBtn.disabled = true;
            detailBtn.disabled = true;
            copyTrackingBtn.disabled = true;
            log('å¼€å§‹è·å–è®¢å•æ•°æ®...');

            let allItems = [];
            let page = 1;
            let totalPages = 1;
            let hasMore = true;
            try {
                while (page <= totalPages && allItems.length < pageSizeTarget && hasMore) {
                    const timestamp = Date.now();
                    const url = 'https://vip.ciweiyunyin.com/api/order/list';
                    const params = { page, pageSize: perRequest, is_agent: 0, _t: timestamp };
                    const response = await fetch(`${url}?${new URLSearchParams(params)}`, {
                        headers: {
                            'Accept': 'application/json',
                            'Authorization': authHeader,
                            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                        }
                    });
                    if (!response.ok) throw new Error(`HTTP ${response.status}`);
                    const data = await response.json();
                    const items = data.items || [];
                    allItems = allItems.concat(items);
                    log(`ç¬¬ ${page} é¡µ, è·å–åˆ° ${items.length} æ¡è®¢å•`);
                    if (page === 1) {
                        const pagination = data.pagination || {};
                        const totalItems = pagination.total_items || 0;
                        const perPage = pagination.per_page || 20;
                        const neededPages = Math.ceil(pageSizeTarget / perRequest);
                        const realTotalPages = Math.ceil(totalItems / perPage);
                        totalPages = Math.min(realTotalPages, neededPages);
                    }
                    if (items.length === 0) hasMore = false;
                    page++;
                }
                STATE.orderItems = allItems.slice(0, pageSizeTarget);
                STATE.selectedRowIndex = -1;
                STATE.currentDetailOrder = null;
                renderOrderTable(STATE.orderItems);
                log(`æˆåŠŸè·å– ${STATE.orderItems.length} ä¸ªè®¢å•`);
                setStatus(`å·²è·å– ${STATE.orderItems.length} ä¸ªè®¢å•`);
                saveConfig();
            } catch (err) {
                log(`è·å–å¤±è´¥: ${err.message}`);
                setStatus('è·å–è®¢å•å¤±è´¥');
                alert('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€ä»¤ç‰Œæˆ–CORSï¼š' + err.message);
            } finally {
                fetchBtn.disabled = false;
            }
        }

        function clearLog() {
            logContent.innerText = '[ç³»ç»Ÿ] æ—¥å¿—å·²æ¸…ç©º Â· é»˜è®¤3000';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        function bindEvents() {
            saveTokenBtn.addEventListener('click', saveToken);
            clearTokenBtn.addEventListener('click', clearToken);
            fetchBtn.addEventListener('click', fetchOrders);
            detailBtn.addEventListener('click', function(){
                if (STATE.selectedRowIndex !== -1) {
                    showOrderDetail(STATE.orderItems[STATE.selectedRowIndex]);
                    switchTab('detailView');
                } else alert('è¯·å…ˆé€‰ä¸­ä¸€ä¸ªè®¢å•');
            });
            copyTrackingBtn.addEventListener('click', copyTrackingNumber);
            clearLogBtn.addEventListener('click', clearLog);
            tabs.forEach(tab => tab.addEventListener('click', function() {
                switchTab(this.dataset.tab);
            }));
            tokenInput.addEventListener('input', saveConfig);
            countInput.addEventListener('change', saveConfig);
        }

        function init() {
            loadConfig();
            bindEvents();
            log('è¶…ç´§å‡‘ç‰ˆ Â· ä»¤ç‰Œæ©ç  Â· è®¢å•IDå‰3*å3 Â· æ—¶é—´æ— ç§’ Â· çœä»½ç®€ç§° Â· é»˜è®¤3000 (æ•°é‡é€‰æ‹©å·²éšè—)');
        }
        init();
    })();
</script>
</body>
</html>